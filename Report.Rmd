---
title: "Forest Fires in Brazil"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tsibble)
library(lubridate)
library(readr)
```
##Cover page


##Contents


##Introduction
Forest fires are a serious problem for the preservation of the Tropical Forests. Understanding the frequency of forest fires in a time series can help to take action to prevent them. Brazil has the largest rainforest on the planet that is the Amazon rainforest. The dataset "amazon" report of the number of forest fires in Brazil divided by states. The series comprises the period of approximately 10 years (1998 to 2017). The data were obtained from the official website of the Brazilian government.


The aim of this report is to analyse the amazon dataset to assess the evolution of fires over the years as well as the regions where they were concentrated, and forecast the frequency of forest fires for the next (FEW) years.


##The Amazon Dataset
```{r}
fires <- read.csv("amazon.csv")
head(fires)
```
The year column records the year when forest fires happened, the state column records the Brazilian state in which forest fires happened and comprises of Acre, Amapá, Pará, Amazonas, Rondonia, Roraima, and part of Mato Grosso, Tocantins, and Maranhão. The frequency of forest fires reported are collected in the numbers column and the month information is collected in the month column, recorded in Portuguese. The date column reports the date when forest fires were reported.

#Descriptive Statistics
```{r}
plot.ts(fires)
fires %>% 
  count(date, wt = number) %>% 
  ggplot(aes(x = date, y = n)) +
  geom_point()

library(ggplot2)
fires %>%
  filter(sum(number) >= 1000) %>%
  mutate(state=forcats::fct_reorder(state,number)) %>%
  ggplot(aes(x=state, y=number))+
  geom_bar(stat = "identity")+
  coord_flip()
```


##Cleaning the Data
#Translating the Month Terms
It should be noted that the month terms in the data set are in Portuguese and as such are not passable to standard date conversion functions. These must be translated in order to connect accurate dates to the data. There is an issue with this however, as the term that describes March uses non-standard characters and cannot be directly converted. 


First we need to access the term and store it in an object. This object is obtained by filtering the data down to only rows that contain some non-alphabetic characters and then taking the first term. It should be noted that there is only one such problem term, so doing this is not an issue.
```{r}
problem_term <- fires %>%
  filter(stringr::str_detect(month, "[^a-zA-Z]")) %>%
  slice(1) %>%
  pull(month)
```


Now that we have an explicit definition of the problem term: `r problem_term`, it is possible to encode the direct conversions. The date is also created based on these months using the first day of the month as a day reference.
```{r}
fires_date <- fires %>%
  mutate(month_clean = case_when(
    month == "Abril"        ~ "April",
    month == "Agosto"       ~ "August",
    month == "Dezembro"     ~ "December",
    month == "Fevereiro"    ~ "February",
    month == "Janeiro"      ~ "January",
    month == "Julho"        ~ "July",
    month == "Junho"        ~ "June",
    month == "Maio"         ~ "May",
    month == problem_term     ~  "March",
    month == "Novembro"     ~ "November",
    month == "Outubro"      ~ "October",
    month == "Setembro"     ~ "September",
    TRUE                    ~ NA_character_
  ),
  day = 1) %>%
  mutate(date_month = lubridate::ymd(glue::glue("{year}-{month_clean}-{day}"))) %>%
  mutate(date_index = yearmonth(date_month))
```


# Creating the clean fire object
```{r}
fires_clean <-
  fires_date %>%
  filter(!(state %in% c("Mato Grosso", "Rio", "Paraiba"))) %>%
  filter(duplicated(.) == FALSE) %>%
  as_tsibble(index = date_index, key = state) %>%
  select(-c(month, date, day, date_month)) %>%
  rename(date = date_index, month = month_clean, fires = number)

fires_clean_all <-
  fires_date %>%
  filter(!(state %in% c("Mato Grosso", "Rio", "Paraiba"))) %>%
  filter(duplicated(.) == FALSE) %>%
  group_by(date_index) %>%
  summarise(fires = sum(number)) %>%
  as_tsibble(index = date_index) %>%
  rename(date = date_index)


# Save the clean data
write_rds(fires_clean, here::here("data", "fires_clean.rds"))
write_rds(fires_clean_all, here::here("data", "fires_clean_all.rds"))
```



##STL decomposition
```{r}
fires_clean <- read_rds(here::here("data", "fires_clean.rds"))
fires_all <- read_rds(here::here("data", "fires_clean_all.rds"))

fires_all %>%
  gg_season(y = fires)

fires_all %>%
  gg_subseries(y = fires)
```
The seasonal time series plot shows there is a seasonal trend of most forest fires during winter (July to August) in most years with the next most frequent season being spring (September to November).

```{r}
fires_all %>% feasts::STL(fires ~ season(window = Inf)) %>% autoplot()
```

#Classical Decomposition
```{r}
fires_all %>%
  classical_decomposition() %>%
  autoplot()
```

## Deseasoning

```{r}
fires_a <- read_rds(here::here("data", "fires_clean_all.rds"))

MA <- NULL
CMA <- NULL

for(i in 1:238){
  MA[i+1] <- (fires_a$fires[i] + fires_a$fires[i+1]
              + fires_a$fires[i+2])/3
}

for(i in 1:237){
  CMA[i+2] <- (MA[i+1] + MA[i+2])/2
}



n_alt <- NULL

for(i in 3:238){
  n_alt[i] <- fires_a$fires[i]/CMA[i]
}

n_alt[239] <- NA
n_alt[which(is.nan(n_alt))] <- 0

month <- NULL
for(i in 1:239){
  month[i] <- i%%12
}

fires_b <- as.data.frame(cbind(fires_a, month, MA, CMA, n_alt))

winter <- subset(fires_b,
                 fires_b$month == 12 |
                   fires_b$month == 1 |
                   fires_b$month == 2)
spring <- subset(fires_b,
                 fires_b$month == 3 |
                   fires_b$month == 4 |
                   fires_b$month == 5)
summer <- subset(fires_b,
                 fires_b$month == 6 |
                   fires_b$month == 7 |
                   fires_b$month == 8)
autumn <- subset(fires_b,
                 fires_b$month == 9 |
                   fires_b$month == 10 |
                   fires_b$month == 11)

m_alt_winter <- mean(winter$n_alt, na.rm = TRUE)
m_alt_spring <- mean(spring$n_alt, na.rm = TRUE)
m_alt_summer <- mean(summer$n_alt, na.rm = TRUE)
m_alt_autumn <- mean(autumn$n_alt, na.rm = TRUE)

m_alt <- c(m_alt_winter, m_alt_spring, m_alt_summer, m_alt_autumn)
m_alt_sum <- sum(m_alt)

for(i in 1:4){
  m_alt[i] <- m_alt[i]*4/m_alt_sum
}

for(i in 1:length(winter$fires)){
  winter[i,7] <- winter$fires[i]/m_alt[1]
}

for(i in 1:length(spring$fires)){
  spring[i,7] <- spring$fires[i]/m_alt[2]
}

for(i in 1:length(summer$fires)){
  summer[i,7] <- summer$fires[i]/m_alt[3]
}

for(i in 1:length(autumn$fires)){
  autumn[i,7] <- autumn$fires[i]/m_alt[4]
}


fires_des <- as.data.frame(rbind(winter,spring,summer,autumn))
fires_des$index <- as.numeric(row.names(fires_des))

fires_des %>%
  count(index, wt = V7) %>%
  ggplot(aes(x = index, y = n)) +
  geom_point()
```

##Model Specification

# linear model
```{r}
fit1 <- lm(fires_des$fires ~ fires_des$index)
fitA <- fit1
```
# ARIMA models
```{r}
acf(fires_des$fires, lag.max = 50) # outside conf int until 50
pacf(fires_des$fires) # spikes at 2,3,6

arima101 <- arima(fires_des$fires, order = c(1,0,1))
coeftest(arima101) # significant
arima202 <- arima(fires_des$fires, order = c(2,0,2))
coeftest(arima202) # inasignificant
# try differencing
arima111 <- arima(fires_des$fires, order = c(1,1,1))
coeftest(arima111) # significant
acf(arima202$residuals) # needs more ma
pacf(arima202$residuals) # needs more ar

arima212 <- arima(fires_des$fires, order = c(2,1,2))
coeftest(arima212) # significant
acf(arima212$residuals) # needs more ma
pacf(arima212$residuals) # perfect

arima213 <- arima(fires_des$fires, order = c(2,1,3))
fit_B <- arima213
```

*James'  seasonal ARIMA*

##Parameter Estimation

##Model Diagnostics
```{r}
summary(fit1) # significant

coeftest(arima213) # ma1 term insignificant. Other terms highly significant.
acf(arima213$residuals) # perfect
pacf(arima213$residuals) # perfect
```

##Forecasting

# December 2017
```{r}
prediction_A <- (1700.243 + 3.371*240)*m_alt[1]
prediction_A # 2109.442
prediction_B <- forecast(fit_B, h = 1)
prediction_B # 1915.295
```
*seasonal ARIMA prediction*

*forecast plots*

##Conclusion

##References
